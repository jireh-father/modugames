<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>ëª¨ì—¬ë´ìš” ë™ë¬¼ì¹œêµ¬ v4</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{background:#2d5a1b;overflow:hidden;touch-action:none;font-family:'Segoe UI',sans-serif;user-select:none;color:#fff}
canvas{display:block}

#topBar{position:fixed;top:0;left:0;right:0;display:flex;justify-content:space-between;align-items:center;padding:8px 12px;pointer-events:none;z-index:10}
#topBar>div{background:rgba(62,39,20,.75);padding:6px 14px;border-radius:14px;font-size:13px;font-weight:bold;color:#f5deb3;border:1px solid rgba(139,90,43,.5)}

#phase{position:fixed;top:46px;left:50%;transform:translateX(-50%);padding:5px 18px;border-radius:12px;font-size:13px;font-weight:bold;z-index:10;pointer-events:none;transition:all .3s}
#phase.plan{background:rgba(76,175,80,.3);color:#a5d6a7;border:1px solid rgba(76,175,80,.4)}
#phase.exec{background:rgba(255,152,0,.3);color:#ffcc80;border:1px solid rgba(255,152,0,.4)}

#animalStatus{position:fixed;top:72px;left:50%;transform:translateX(-50%);display:flex;gap:5px;pointer-events:none;z-index:10}
.as{padding:3px 10px;border-radius:10px;font-size:11px;font-weight:bold;background:rgba(62,39,20,.7);border:1px solid rgba(139,90,43,.4);color:#f5deb3}
.as.done{opacity:.35;text-decoration:line-through}

#timerMod{position:fixed;bottom:140px;left:50%;transform:translateX(-50%);background:rgba(255,152,0,.88);color:#fff;padding:5px 16px;border-radius:12px;font-size:12px;font-weight:bold;z-index:15;cursor:pointer;display:none;border:1px solid rgba(255,200,0,.5)}

#controls{position:fixed;bottom:0;left:0;right:0;z-index:20;background:linear-gradient(transparent,rgba(30,20,10,.85) 30%);padding:6px 8px 10px}
#itemBar{display:flex;gap:5px;justify-content:center;flex-wrap:wrap;margin-bottom:6px}
.item-btn{padding:6px 10px;border-radius:12px;font-size:12px;font-weight:bold;cursor:pointer;border:2px solid transparent;transition:all .15s;display:flex;flex-direction:column;align-items:center;gap:1px;min-width:54px;position:relative}
.item-btn:active{transform:scale(.93)}
.item-btn.sel{transform:scale(1.05);box-shadow:0 0 14px rgba(255,255,255,.25)}
.item-btn .qty{font-size:10px;opacity:.7}
.item-btn.disabled{opacity:.3;pointer-events:none}
.item-btn .i-emoji{font-size:18px}
.item-btn .i-info{font-size:9px;opacity:.6}

.item-btn.cute{background:rgba(233,30,99,.15);color:#f48fb1;border-color:rgba(233,30,99,.3)}
.item-btn.cute.sel{background:rgba(233,30,99,.4)}
.item-btn.scary{background:rgba(69,90,100,.22);color:#b0bec5;border-color:rgba(69,90,100,.4)}
.item-btn.scary.sel{background:rgba(69,90,100,.5)}
.item-btn.timer{background:rgba(255,152,0,.18);color:#ffb74d;border-color:rgba(255,152,0,.35)}
.item-btn.timer.sel{background:rgba(255,152,0,.45)}

#actBtns{display:flex;gap:8px;justify-content:center}
.act-btn{padding:9px 20px;border-radius:14px;font-size:13px;font-weight:bold;cursor:pointer;border:1px solid rgba(255,255,255,.15);transition:all .15s}
.act-btn:active{transform:scale(.93)}
#btnUndo{background:rgba(255,255,255,.08);color:#a1887f}
#btnClear{background:rgba(255,255,255,.06);color:#a1887f}
#btnStart{background:linear-gradient(135deg,#e65100,#ff9800);color:#fff;font-size:15px;padding:10px 30px;box-shadow:0 0 18px rgba(255,152,0,.35)}
#btnStart.disabled{background:rgba(80,60,40,.4);box-shadow:none;opacity:.5}

.overlay{position:fixed;inset:0;display:none;flex-direction:column;align-items:center;justify-content:center;z-index:100}
.overlay button{border:none;padding:13px 40px;border-radius:24px;font-size:17px;cursor:pointer;font-weight:bold;margin:5px;color:#fff}
.overlay button:active{transform:scale(.95)}

#startScreen{background:radial-gradient(ellipse at 50% 60%,#3e6b1e 0%,#1a3a0a 60%,#0d1f05 100%)}
#startScreen h1{font-size:36px;margin-bottom:2px;color:#c8e6c9;text-shadow:0 2px 8px rgba(0,0,0,.4)}
#startScreen .sub{font-size:14px;color:#a5d6a7;margin-bottom:18px}
#startScreen .rules{background:rgba(0,0,0,.25);border-radius:16px;padding:16px 22px;margin-bottom:22px;max-width:340px;text-align:left;line-height:1.9;font-size:13px;color:#c8e6c9;border:1px solid rgba(76,175,80,.2)}
#startScreen button{background:linear-gradient(135deg,#2e7d32,#66bb6a);box-shadow:0 4px 16px rgba(46,125,50,.5)}

#gameOver{background:rgba(30,10,5,.94)}
#gameOver h2{font-size:36px;color:#ef5350;margin-bottom:6px}
#gameOver .sub{color:#ef9a9a;margin-bottom:16px;font-size:15px}
#gameOver button{background:linear-gradient(135deg,#c62828,#ef5350)}

#levelClear{background:rgba(10,30,10,.94)}
#levelClear h2{font-size:30px;margin-bottom:8px;color:#c8e6c9}
#lcStars{font-size:44px;color:#ffd54f;margin-bottom:4px}
#lcInfo{color:#a5d6a7;margin-bottom:8px;font-size:14px}
#rewardLabel{color:#ffd54f;font-size:15px;font-weight:bold;margin-bottom:8px}
#rewardOptions{display:flex;gap:8px;justify-content:center;flex-wrap:wrap;margin-bottom:6px}
.reward-opt{display:flex;flex-direction:column;align-items:center;padding:10px 14px;border-radius:14px;cursor:pointer;border:2px solid rgba(255,255,255,.15);transition:all .2s;background:rgba(255,255,255,.06);min-width:72px}
.reward-opt:active{transform:scale(.95)}
.reward-opt .r-emoji{font-size:30px;margin-bottom:3px}
.reward-opt .r-name{font-size:12px;color:#fff;font-weight:bold}
.reward-opt .r-desc{font-size:10px;color:rgba(255,255,255,.5);margin-top:2px}
.reward-opt.picked{border-color:#ffd54f;background:rgba(255,215,0,.15);box-shadow:0 0 12px rgba(255,215,0,.3)}
#lcBonus{color:#b39ddb;margin-bottom:12px;font-size:13px}
#levelClear .btns{display:flex;gap:8px}
#levelClear .btns button.r{background:linear-gradient(135deg,#795548,#a1887f)}
#levelClear .btns button.n{background:linear-gradient(135deg,#2e7d32,#66bb6a)}
</style>
</head>
<body>
<div class="overlay" id="startScreen" style="display:flex">
  <h1>ëª¨ì—¬ë´ìš” ë™ë¬¼ì¹œêµ¬</h1>
  <div class="sub">ê°™ì€ ë™ë¬¼ë¼ë¦¬ ëª¨ì•„ì£¼ì„¸ìš”!</div>
  <div class="rules">
    ğŸ¶ğŸ±ğŸ°ğŸ»ğŸ¦Š ê°™ì€ ë™ë¬¼ì„ í•©ì³ì£¼ì„¸ìš”!<br>
    ğŸ¶ <b>ê·€ì—¬ìš´ ë™ë¬¼</b>: ì¹œêµ¬ë¥¼ ëŒì–´ë‹¹ê²¨ìš”<br>
    ğŸº <b>ë¬´ì„œìš´ ë™ë¬¼</b>: ì¹œêµ¬ë¥¼ ë°€ì–´ë‚´ìš”<br>
    â±ï¸ <b>íƒ€ì´ë¨¸</b>: ì§€ì—° í›„ íš¨ê³¼ ë°œë™!<br>
    ğŸª¨ ì¥ì• ë¬¼ì„ í”¼í•´ì„œ ë°°ì¹˜í•˜ì„¸ìš”<br>
    ğŸ í´ë¦¬ì–´í•˜ë©´ ë™ë¬¼ ì•„ì´í…œ íšë“!<br>
    ğŸ’¥ ë‹¤ë¥¸ ë™ë¬¼ë¼ë¦¬ ë¶€ë”ªíˆë©´ ì‹¤íŒ¨!
  </div>
  <button onclick="startGame()">ì‹œì‘í•˜ê¸°</button>
</div>

<div id="topBar">
  <div id="levelDisp">ìˆ² 1</div>
  <div id="scoreDisp">ì ìˆ˜: 0</div>
  <div id="coinDisp">ğŸŒ° 0</div>
</div>
<div id="phase" class="plan">ë°°ì¹˜ ë‹¨ê³„</div>
<div id="animalStatus"></div>
<div id="timerMod" onclick="selectedTimer=null;updateAllUI()"></div>

<div id="controls">
  <div id="itemBar"></div>
  <div id="actBtns">
    <div class="act-btn" id="btnUndo" onclick="undoPlace()">â†© ë˜ëŒë¦¬ê¸°</div>
    <div class="act-btn" id="btnClear" onclick="clearAll()">âœ• ì „ë¶€ì‚­ì œ</div>
    <div class="act-btn" id="btnStart" onclick="executeSkills()">â–¶ ì‹œì‘!</div>
  </div>
</div>

<div class="overlay" id="gameOver">
  <h2>ìœ¼ì•™!</h2>
  <div class="sub" id="goReason"></div>
  <button onclick="retryLevel()">ë‹¤ì‹œ ë„ì „</button>
</div>

<div class="overlay" id="levelClear">
  <h2 id="lcTitle">í´ë¦¬ì–´!</h2>
  <div id="lcStars"></div>
  <div id="lcInfo"></div>
  <div id="rewardLabel">ğŸ ë³´ìƒì„ ì„ íƒí•˜ì„¸ìš”!</div>
  <div id="rewardOptions"></div>
  <div id="lcBonus"></div>
  <div class="btns" id="lcBtns" style="display:none">
    <button class="r" onclick="retryLevel()">ë‹¤ì‹œ</button>
    <button class="n" onclick="nextLevel()">ë‹¤ìŒ ìˆ² â†’</button>
  </div>
</div>

<canvas id="c"></canvas>

<script>
const canvas=document.getElementById('c'),ctx=canvas.getContext('2d');
let W,H;
function resize(){W=canvas.width=innerWidth;H=canvas.height=innerHeight;}
resize();addEventListener('resize',resize);
canvas.addEventListener('contextmenu',e=>e.preventDefault());

// â•â•â• Audio â•â•â•
const AC=new(AudioContext||webkitAudioContext)();
function snd(f,d,t='sine',v=.08){const o=AC.createOscillator(),g=AC.createGain();o.type=t;o.frequency.value=f;g.gain.setValueAtTime(v,AC.currentTime);g.gain.exponentialRampToValueAtTime(.001,AC.currentTime+d);o.connect(g);g.connect(AC.destination);o.start();o.stop(AC.currentTime+d)}
function sndPlace(){snd(600,.1);snd(800,.07,'sine',.05)}
function sndRemove(){snd(350,.08)}
function sndExec(){snd(500,.15);snd(700,.12,'sine',.06);setTimeout(()=>snd(900,.1,'sine',.05),80)}
function sndMerge(c){const b=500+c*60;snd(b,.4,'sine',.15);snd(b*1.5,.25,'sine',.07);snd(b*2,.2,'sine',.04)}
function sndDeath(){snd(200,.3,'sawtooth',.1);setTimeout(()=>snd(120,.4,'sawtooth',.08),120)}
function sndWin(){[523,659,784,1047].forEach((f,i)=>setTimeout(()=>snd(f,.22,'sine',.1),i*110))}
function sndBounce(){snd(250,.06,'sine',.04)}
function sndRoar(){snd(120,.25,'sawtooth',.12);snd(80,.3,'sawtooth',.08)}

// â•â•â• Animals (0-4 cute board+pull, 5-7 scary push) â•â•â•
const ANIMALS=[
  {name:'ê°•ì•„ì§€',emoji:'ğŸ¶',bodyColor:'#e8b96e',earColor:'#c4873a',cheekColor:'#f5c4c4',noseColor:'#4a3728',scary:false},
  {name:'ê³ ì–‘ì´',emoji:'ğŸ±',bodyColor:'#f0d6a8',earColor:'#f0b88a',cheekColor:'#fcc',noseColor:'#e88ca5',scary:false},
  {name:'í† ë¼',emoji:'ğŸ°',bodyColor:'#f5e6f0',earColor:'#f5b5c8',cheekColor:'#fcc',noseColor:'#e88ca5',scary:false},
  {name:'ê³°',emoji:'ğŸ»',bodyColor:'#c49464',earColor:'#a07040',cheekColor:'#e8a8a0',noseColor:'#4a3020',scary:false},
  {name:'ì—¬ìš°',emoji:'ğŸ¦Š',bodyColor:'#f0944a',earColor:'#d06828',cheekColor:'#fce4b8',noseColor:'#3a2818',scary:false},
  {name:'ëŠ‘ëŒ€',emoji:'ğŸº',bodyColor:'#9e9e9e',earColor:'#616161',cheekColor:'#bdbdbd',noseColor:'#424242',scary:true,earStyle:'pointy'},
  {name:'í˜¸ë‘ì´',emoji:'ğŸ¯',bodyColor:'#ef8c3c',earColor:'#c45c20',cheekColor:'#fce0b8',noseColor:'#3a2010',scary:true,special:'stripes'},
  {name:'ì‚¬ì',emoji:'ğŸ¦',bodyColor:'#d4a030',earColor:'#a07820',cheekColor:'#e8c880',noseColor:'#5a4020',scary:true,special:'mane'},
];

// â•â•â• Item Types â•â•â•
const ITEM_TYPES={
  puppy: {animalIdx:0,type:'pull',range:120,power:2.5,duration:240},
  cat:   {animalIdx:1,type:'pull',range:140,power:2.0,duration:260},
  rabbit:{animalIdx:2,type:'pull',range:100,power:3.2,duration:200},
  bear:  {animalIdx:3,type:'pull',range:160,power:1.8,duration:300},
  fox:   {animalIdx:4,type:'pull',range:130,power:2.8,duration:220},
  wolf:  {animalIdx:5,type:'push',range:200,power:3.5},
  tiger: {animalIdx:6,type:'push',range:260,power:4.5},
  lion:  {animalIdx:7,type:'push',range:320,power:5.5},
  timer1:{type:'timer',seconds:1},
  timer2:{type:'timer',seconds:2},
  timer3:{type:'timer',seconds:3},
};

// â•â•â• State â•â•â•
let animals=[],emitters=[],particles=[],flashes=[],ripples=[],obstacles=[];
let phase='plan',selectedItem=null,selectedTimer=null;
let level=1,score=0,totalScore=0,coins=0;
let inventory={};
let execTimer=0,comboCount=0;
let shakeT=0,shakeX=0,shakeY=0;
let ghostPos=null,collisionPt=null;
let settledTimer=0;
let grassTufts=[],flowers=[],trees=[];

const ORB_R=24,FRICTION=.979;

// â•â•â• Levels â•â•â•
// a=animal types, n=per type, par=optimal items, layout=cluster arrangement
const LEVELS=[
  {a:2,n:2,items:{puppy:2,wolf:1},obs:1,par:2,layout:'corners'},
  {a:2,n:3,items:{puppy:2,wolf:1},obs:2,par:2,layout:'sides'},
  {a:3,n:2,items:{puppy:2,cat:1,wolf:1},obs:2,par:3,layout:'corners'},
  {a:3,n:3,items:{puppy:2,cat:1,wolf:1},obs:3,par:3,layout:'triangle'},
  {a:4,n:2,items:{puppy:2,cat:1,rabbit:1,wolf:1},obs:3,par:4,layout:'corners'},
  {a:4,n:3,items:{puppy:2,cat:1,bear:1,wolf:1,tiger:1},obs:4,par:4,layout:'line'},
  {a:3,n:4,items:{puppy:2,cat:1,fox:1,wolf:1},obs:4,par:3,layout:'triangle'},
  {a:5,n:2,items:{puppy:2,cat:1,rabbit:1,fox:1,wolf:1},obs:4,par:5,layout:'ring'},
  {a:5,n:3,items:{puppy:2,cat:1,bear:1,fox:1,wolf:1,tiger:1},obs:5,par:5,layout:'ring'},
  {a:5,n:4,items:{puppy:2,cat:1,bear:1,fox:1,wolf:1,tiger:1,lion:1},obs:6,par:5,layout:'corners'},
];

function generateBG(){
  grassTufts=[];flowers=[];trees=[];
  for(let i=0;i<50;i++)grassTufts.push({x:Math.random()*W,y:Math.random()*H,s:Math.random()*.6+.4,r:Math.random()*Math.PI});
  const fc=['#f8bbd0','#fff176','#ce93d8','#81d4fa','#ffcc80','#c8e6c9'];
  for(let i=0;i<20;i++)flowers.push({x:Math.random()*W,y:Math.random()*H,s:Math.random()*.5+.3,c:fc[Math.floor(Math.random()*fc.length)],p:Math.random()*Math.PI*2});
  for(let i=0;i<8;i++)trees.push({x:Math.random()*W,y:Math.random()*H,s:Math.random()*.4+.6});
}
generateBG();

function mkA(x,y,t){return{x,y,vx:0,vy:0,radius:ORB_R,type:t,mergeCount:0,blink:Math.random()*300,blinkTimer:0,bounce:0,danger:0,wobble:Math.random()*Math.PI*2,happy:0}}

function initLevel(lvl){
  const cfg=LEVELS[Math.min(lvl-1,LEVELS.length-1)];
  animals=[];emitters=[];particles=[];flashes=[];ripples=[];obstacles=[];
  phase='plan';selectedItem=null;selectedTimer=null;
  comboCount=0;execTimer=0;score=0;
  collisionPt=null;ghostPos=null;settledTimer=0;shakeT=0;

  inventory={};
  for(const[k,v]of Object.entries(cfg.items))inventory[k]=(inventory[k]||0)+v;
  if(window._bonusItems){
    for(const[k,v]of Object.entries(window._bonusItems))inventory[k]=(inventory[k]||0)+v;
    window._bonusItems=null;
  }

  const margin=50,playTop=105,playBot=H-120;
  const playW=W-margin*2,playH=playBot-playTop;
  const clusterR=55; // same-type animals within this radius
  const minSep=200;  // min distance between cluster centers (> max pull range)

  // â”€â”€ Determine cluster center positions based on layout â”€â”€
  const centers=[];
  const layout=cfg.layout||'corners';

  if(layout==='corners'){
    const spots=[
      {x:margin+100,y:playTop+90},
      {x:W-margin-100,y:playTop+90},
      {x:margin+100,y:playBot-90},
      {x:W-margin-100,y:playBot-90},
      {x:W/2,y:(playTop+playBot)/2}
    ];
    for(let a=0;a<cfg.a;a++)centers.push(spots[a%spots.length]);
  }else if(layout==='sides'){
    const lx=margin+110,rx=W-margin-110,cy=(playTop+playBot)/2;
    centers.push({x:lx,y:cy});
    centers.push({x:rx,y:cy});
    for(let a=2;a<cfg.a;a++)centers.push({x:W/2,y:playTop+80+((playH-160)/(cfg.a-1))*a});
  }else if(layout==='triangle'){
    centers.push({x:W/2,y:playTop+80});
    centers.push({x:margin+120,y:playBot-100});
    centers.push({x:W-margin-120,y:playBot-100});
    for(let a=3;a<cfg.a;a++){
      const ang=(Math.PI*2/cfg.a)*a;
      centers.push({x:W/2+Math.cos(ang)*180,y:(playTop+playBot)/2+Math.sin(ang)*140});
    }
  }else if(layout==='line'){
    for(let a=0;a<cfg.a;a++){
      const x=margin+100+((playW-200)/(Math.max(cfg.a-1,1)))*a;
      const y=(playTop+playBot)/2+(a%2===0?-30:30);
      centers.push({x,y});
    }
  }else if(layout==='ring'){
    const cx=W/2,cy=(playTop+playBot)/2;
    const ringR=Math.min(playW*0.33,playH*0.33);
    for(let a=0;a<cfg.a;a++){
      const ang=(Math.PI*2/cfg.a)*a-Math.PI/2;
      centers.push({x:cx+Math.cos(ang)*ringR,y:cy+Math.sin(ang)*ringR});
    }
  }

  // â”€â”€ Place same-type animals in tight clusters â”€â”€
  for(let a=0;a<cfg.a;a++){
    const c=centers[a];
    for(let i=0;i<cfg.n;i++){
      const ang=(Math.PI*2/cfg.n)*i+(Math.random()-.5)*.6;
      const dist=15+Math.random()*(clusterR-15);
      let x=c.x+Math.cos(ang)*dist;
      let y=c.y+Math.sin(ang)*dist;
      x=Math.max(margin+ORB_R,Math.min(W-margin-ORB_R,x));
      y=Math.max(playTop+ORB_R,Math.min(playBot-ORB_R,y));
      // nudge if overlapping another animal
      let att=0;
      while(att<50){
        let ok=true;
        for(const ea of animals)if(Math.sqrt((x-ea.x)**2+(y-ea.y)**2)<ORB_R*2.5){ok=false;break;}
        if(ok)break;
        const a2=(Math.PI*2/cfg.n)*i+Math.random()*Math.PI*2;
        const d2=15+Math.random()*(clusterR-15);
        x=c.x+Math.cos(a2)*d2;y=c.y+Math.sin(a2)*d2;
        x=Math.max(margin+ORB_R,Math.min(W-margin-ORB_R,x));
        y=Math.max(playTop+ORB_R,Math.min(playBot-ORB_R,y));
        att++;
      }
      animals.push(mkA(x,y,a));
    }
  }

  // â”€â”€ Place obstacles between clusters, never inside â”€â”€
  const ot=['rock','log','bush'];
  for(let i=0;i<cfg.obs;i++){
    let x,y,att=0,ok;
    do{
      x=margin+30+Math.random()*(playW-60);
      y=playTop+30+Math.random()*(playH-60);
      ok=true;
      // must not be inside any cluster (>clusterR+40 from center)
      for(const c of centers)if(Math.sqrt((x-c.x)**2+(y-c.y)**2)<clusterR+50){ok=false;break;}
      // must not overlap other obstacles
      for(const o of obstacles)if(Math.sqrt((x-o.x)**2+(y-o.y)**2)<60){ok=false;break;}
      att++;
    }while(!ok&&att<200);
    obstacles.push({x,y,type:ot[Math.floor(Math.random()*3)],radius:20+Math.random()*14});
  }

  generateBG();buildItemBar();updateAllUI();
  document.getElementById('phase').className='plan';
  document.getElementById('phase').textContent='ë°°ì¹˜ ë‹¨ê³„ ğŸŒ¿';
  showControls(true);
}

// â•â•â• UI â•â•â•
function buildItemBar(){
  const bar=document.getElementById('itemBar');
  let h='';
  // Animal items
  for(const[key,count]of Object.entries(inventory)){
    if(count<=0)continue;
    const it=ITEM_TYPES[key];
    if(!it||it.type==='timer')continue;
    const info=ANIMALS[it.animalIdx];
    const used=emitters.filter(e=>e.itemKey===key).length;
    const rem=count-used;
    const cls=info.scary?'scary':'cute';
    const label=it.type==='pull'?'ëŒê¸°':'ë°€ê¸°';
    h+=`<div class="item-btn ${cls}${selectedItem===key?' sel':''}${rem<=0?' disabled':''}" onclick="selectItem('${key}')">
      <span class="i-emoji">${info.emoji}</span><span class="i-info">${label} ${it.range}</span>
      <span class="qty">x${rem}</span></div>`;
  }
  // Timer items
  for(const[key,count]of Object.entries(inventory)){
    if(count<=0)continue;
    const it=ITEM_TYPES[key];
    if(!it||it.type!=='timer')continue;
    const used=emitters.filter(e=>e.timerKey===key).length;
    const rem=count-used;
    h+=`<div class="item-btn timer${selectedTimer===key?' sel':''}${rem<=0?' disabled':''}" onclick="selectItem('${key}')">
      <span class="i-emoji">â±ï¸</span><span class="i-info">${it.seconds}ì´ˆ</span>
      <span class="qty">x${rem}</span></div>`;
  }
  bar.innerHTML=h;
}

function updateAllUI(){
  document.getElementById('levelDisp').textContent=`ìˆ² ${level}`;
  document.getElementById('scoreDisp').textContent=`ì ìˆ˜: ${totalScore+score}`;
  document.getElementById('coinDisp').textContent=`ğŸŒ° ${coins}`;
  const cfg=LEVELS[Math.min(level-1,LEVELS.length-1)];
  let h='';
  for(let a=0;a<cfg.a;a++){
    const cnt=animals.filter(o=>o.type===a).length;
    h+=`<div class="as${cnt<=1?' done':''}">${ANIMALS[a].emoji} ${cnt>1?'x'+cnt:'OK'}</div>`;
  }
  document.getElementById('animalStatus').innerHTML=h;
  buildItemBar();
  const sb=document.getElementById('btnStart');
  if(emitters.length>0&&phase==='plan')sb.classList.remove('disabled');else sb.classList.add('disabled');
  // Timer modifier indicator
  const tm=document.getElementById('timerMod');
  if(selectedTimer&&phase==='plan'){
    const ts=ITEM_TYPES[selectedTimer].seconds;
    tm.textContent=`â±ï¸ ${ts}ì´ˆ ì§€ì—° ì ìš© ì¤‘ (ëˆŒëŸ¬ì„œ í•´ì œ)`;
    tm.style.display='block';
  }else{tm.style.display='none';}
}

function showControls(s){document.getElementById('controls').style.display=s?'':'none';}

function selectItem(key){
  if(phase!=='plan')return;
  const it=ITEM_TYPES[key];
  if(it.type==='timer'){
    selectedTimer=selectedTimer===key?null:key;
  }else{
    selectedItem=selectedItem===key?null:key;
  }
  updateAllUI();
}

// â•â•â• Placement â•â•â•
canvas.addEventListener('pointerdown',e=>{
  e.preventDefault();
  if(phase!=='plan'||!selectedItem)return;
  const it=ITEM_TYPES[selectedItem];
  if(!it||it.type==='timer')return;
  const used=emitters.filter(em=>em.itemKey===selectedItem).length;
  if(used>=(inventory[selectedItem]||0))return;
  if(selectedTimer){
    const usedT=emitters.filter(em=>em.timerKey===selectedTimer).length;
    if(usedT>=(inventory[selectedTimer]||0)){selectedTimer=null;updateAllUI();}
  }
  const x=e.clientX,y=e.clientY;
  if(y<95||y>H-100)return;
  for(const a of animals)if(Math.sqrt((x-a.x)**2+(y-a.y)**2)<a.radius+8)return;
  for(const o of obstacles)if(Math.sqrt((x-o.x)**2+(y-o.y)**2)<o.radius+8)return;
  for(const em of emitters)if(Math.sqrt((x-em.x)**2+(y-em.y)**2)<28)return;

  const timerSec=selectedTimer?ITEM_TYPES[selectedTimer].seconds:0;
  emitters.push({x,y,itemKey:selectedItem,timerKey:selectedTimer||null,
    type:it.type,animalIdx:it.animalIdx,range:it.range,power:it.power,
    duration:it.duration||0,timerSec,age:0,fadeAge:0,active:false,fired:false,roarBounce:0});
  sndPlace();updateAllUI();
});
canvas.addEventListener('pointermove',e=>{if(phase==='plan')ghostPos={x:e.clientX,y:e.clientY};});

function undoPlace(){
  if(phase!=='plan'||!emitters.length)return;
  emitters.pop();sndRemove();updateAllUI();
}
function clearAll(){
  if(phase!=='plan')return;
  emitters=[];sndRemove();updateAllUI();
}

// â•â•â• Execute â•â•â•
function executeSkills(){
  if(phase!=='plan'||!emitters.length)return;
  phase='exec';execTimer=0;comboCount=0;ghostPos=null;settledTimer=0;
  document.getElementById('phase').className='exec';
  document.getElementById('phase').textContent='ì‹¤í–‰ ì¤‘... ğŸƒ';
  showControls(false);
  document.getElementById('timerMod').style.display='none';
  sndExec();
  for(const em of emitters){
    if(em.timerSec<=0){
      em.active=true;em.age=0;
      if(em.type==='push'){
        ripples.push({x:em.x,y:em.y,radius:0,maxRadius:em.range,alpha:1,force:em.power});
        em.fired=true;em.active=false;em.roarBounce=1;sndRoar();
      }
    }
  }
}

// â•â•â• Draw Animal â•â•â•
function drawAnimal(a,opts={}){
  const{isComplete:forceComplete,baseAlpha:bAlpha}=opts;
  const info=ANIMALS[a.type];
  const r=a.radius*(1+(a.bounce||0)*.15);
  const wobble=Math.sin(a.wobble||0)*.03;
  const complete=forceComplete!==undefined?forceComplete:animals.filter(o=>o.type===a.type).length<=1;

  ctx.save();
  if(bAlpha!==undefined)ctx.globalAlpha=bAlpha;
  ctx.translate(a.x,a.y);ctx.rotate(wobble);

  // Shadow
  ctx.fillStyle='rgba(0,0,0,.1)';
  ctx.beginPath();ctx.ellipse(2,r*.6,r*.7,r*.25,0,0,Math.PI*2);ctx.fill();

  // Danger glow
  if((a.danger||0)>.1){
    const dg=ctx.createRadialGradient(0,0,r,0,0,r*2);
    dg.addColorStop(0,`rgba(255,60,60,${a.danger*.3})`);dg.addColorStop(1,'rgba(0,0,0,0)');
    ctx.fillStyle=dg;ctx.beginPath();ctx.arc(0,0,r*2,0,Math.PI*2);ctx.fill();
  }

  // Complete sparkle
  if(complete){
    ctx.strokeStyle=`rgba(255,215,0,${.3+Math.sin(Date.now()*.004)*.15})`;
    ctx.lineWidth=2.5;ctx.beginPath();ctx.arc(0,0,r+5,0,Math.PI*2);ctx.stroke();
  }

  // Lion mane
  if(info.special==='mane'){
    ctx.fillStyle='#b08020';
    for(let i=0;i<12;i++){
      const ang=(Math.PI*2/12)*i;
      ctx.beginPath();ctx.arc(Math.cos(ang)*(r+5),Math.sin(ang)*(r+5),7,0,Math.PI*2);ctx.fill();
    }
  }

  // Body
  const bodyG=ctx.createRadialGradient(-r*.2,-r*.25,r*.1,0,0,r);
  bodyG.addColorStop(0,'#fff');bodyG.addColorStop(.35,info.bodyColor);bodyG.addColorStop(1,info.bodyColor);
  ctx.fillStyle=bodyG;ctx.beginPath();ctx.arc(0,0,r,0,Math.PI*2);ctx.fill();
  ctx.strokeStyle='rgba(0,0,0,.08)';ctx.lineWidth=1;ctx.stroke();

  // Tiger stripes
  if(info.special==='stripes'){
    ctx.strokeStyle='rgba(74,40,0,.35)';ctx.lineWidth=2;ctx.lineCap='round';
    ctx.beginPath();ctx.arc(0,-r*.3,r*.35,-.3,.3);ctx.stroke();
    ctx.beginPath();ctx.arc(-r*.35,r*.05,r*.45,-.4,.1);ctx.stroke();
    ctx.beginPath();ctx.arc(r*.35,r*.05,r*.45,Math.PI-.1,Math.PI+.4);ctx.stroke();
  }

  // Ears
  const earW=r*.35,earH=r*.45,earY=-r*.75;
  if(info.earStyle==='pointy'){
    // Wolf pointy ears
    ctx.fillStyle=info.earColor;
    ctx.beginPath();ctx.moveTo(-r*.55,earY-earH*.7);ctx.lineTo(-r*.3,earY+earH*.3);ctx.lineTo(-r*.7,earY+earH*.3);ctx.closePath();ctx.fill();
    ctx.beginPath();ctx.moveTo(r*.55,earY-earH*.7);ctx.lineTo(r*.3,earY+earH*.3);ctx.lineTo(r*.7,earY+earH*.3);ctx.closePath();ctx.fill();
  }else{
    ctx.fillStyle=info.earColor;
    ctx.beginPath();ctx.ellipse(-r*.45,earY,earW,earH,-.25,0,Math.PI*2);ctx.fill();
    ctx.beginPath();ctx.ellipse(r*.45,earY,earW,earH,.25,0,Math.PI*2);ctx.fill();
    if(!info.scary){
      ctx.fillStyle=info.cheekColor;
      ctx.beginPath();ctx.ellipse(-r*.45,earY+2,earW*.55,earH*.55,-.25,0,Math.PI*2);ctx.fill();
      ctx.beginPath();ctx.ellipse(r*.45,earY+2,earW*.55,earH*.55,.25,0,Math.PI*2);ctx.fill();
    }
  }

  // Eyes
  if(a.blinkTimer!==undefined&&a.blinkTimer!==Infinity){a.blinkTimer--;if(a.blinkTimer<=0)a.blinkTimer=(a.blink||200)+Math.random()*200;}
  const blinking=a.blinkTimer!==undefined&&a.blinkTimer!==Infinity&&a.blinkTimer<8;
  const eyeY=-r*.15,eyeGap=r*.28;

  if(info.scary){
    // Angry eyebrows
    ctx.strokeStyle='#3e2723';ctx.lineWidth=2.5;ctx.lineCap='round';
    ctx.beginPath();ctx.moveTo(-eyeGap-5,eyeY-7);ctx.lineTo(-eyeGap+2,eyeY-3);ctx.stroke();
    ctx.beginPath();ctx.moveTo(eyeGap+5,eyeY-7);ctx.lineTo(eyeGap-2,eyeY-3);ctx.stroke();
    // Amber eyes
    ctx.fillStyle='#ffd600';
    ctx.beginPath();ctx.arc(-eyeGap,eyeY,3.2,0,Math.PI*2);ctx.fill();
    ctx.beginPath();ctx.arc(eyeGap,eyeY,3.2,0,Math.PI*2);ctx.fill();
    ctx.fillStyle='#1a1a1a';
    ctx.beginPath();ctx.arc(-eyeGap,eyeY,1.4,0,Math.PI*2);ctx.fill();
    ctx.beginPath();ctx.arc(eyeGap,eyeY,1.4,0,Math.PI*2);ctx.fill();
  }else if(blinking){
    ctx.strokeStyle='#3e2723';ctx.lineWidth=2;ctx.lineCap='round';
    ctx.beginPath();ctx.moveTo(-eyeGap-3,eyeY);ctx.lineTo(-eyeGap+3,eyeY);ctx.stroke();
    ctx.beginPath();ctx.moveTo(eyeGap-3,eyeY);ctx.lineTo(eyeGap+3,eyeY);ctx.stroke();
  }else if((a.happy||0)>0){
    ctx.strokeStyle='#3e2723';ctx.lineWidth=2;ctx.lineCap='round';
    ctx.beginPath();ctx.arc(-eyeGap,eyeY+2,4,Math.PI,0);ctx.stroke();
    ctx.beginPath();ctx.arc(eyeGap,eyeY+2,4,Math.PI,0);ctx.stroke();
  }else{
    ctx.fillStyle='#3e2723';
    ctx.beginPath();ctx.arc(-eyeGap,eyeY,3,0,Math.PI*2);ctx.fill();
    ctx.beginPath();ctx.arc(eyeGap,eyeY,3,0,Math.PI*2);ctx.fill();
    ctx.fillStyle='#fff';
    ctx.beginPath();ctx.arc(-eyeGap+1,eyeY-1,1.2,0,Math.PI*2);ctx.fill();
    ctx.beginPath();ctx.arc(eyeGap+1,eyeY-1,1.2,0,Math.PI*2);ctx.fill();
  }

  // Cheeks (cute only)
  if(!info.scary){
    ctx.fillStyle=info.cheekColor+'88';
    ctx.beginPath();ctx.ellipse(-r*.42,r*.08,r*.15,r*.1,0,0,Math.PI*2);ctx.fill();
    ctx.beginPath();ctx.ellipse(r*.42,r*.08,r*.15,r*.1,0,0,Math.PI*2);ctx.fill();
  }

  // Nose
  ctx.fillStyle=info.noseColor;
  ctx.beginPath();ctx.moveTo(0,r*.05);ctx.lineTo(-3,r*.13);ctx.lineTo(3,r*.13);ctx.closePath();ctx.fill();

  // Mouth / Fangs
  if(info.scary){
    ctx.fillStyle='#fff';
    ctx.beginPath();ctx.moveTo(-4,r*.15);ctx.lineTo(-2,r*.27);ctx.lineTo(0,r*.15);ctx.fill();
    ctx.beginPath();ctx.moveTo(0,r*.15);ctx.lineTo(2,r*.27);ctx.lineTo(4,r*.15);ctx.fill();
    ctx.strokeStyle='#3e2723';ctx.lineWidth=1.2;ctx.lineCap='round';
    ctx.beginPath();ctx.moveTo(-5,r*.17);ctx.quadraticCurveTo(0,r*.12,5,r*.17);ctx.stroke();
  }else if((a.happy||0)>0){
    ctx.strokeStyle='#5d4037';ctx.lineWidth=1.2;ctx.lineCap='round';
    ctx.beginPath();ctx.arc(0,r*.12,r*.15,.1*Math.PI,.9*Math.PI);ctx.stroke();
  }else{
    ctx.strokeStyle='#5d4037';ctx.lineWidth=1.2;ctx.lineCap='round';
    ctx.beginPath();ctx.moveTo(-3,r*.2);ctx.quadraticCurveTo(0,r*.28,3,r*.2);ctx.stroke();
  }

  // Merge count
  if((a.mergeCount||0)>0){
    ctx.fillStyle='rgba(255,255,255,.85)';ctx.font=`bold ${10+(a.mergeCount||0)*2}px sans-serif`;
    ctx.textAlign='center';ctx.textBaseline='middle';
    ctx.fillText(`x${(a.mergeCount||0)+1}`,0,r*.45);
  }

  // Highlight
  ctx.fillStyle='rgba(255,255,255,.25)';
  ctx.beginPath();ctx.ellipse(-r*.2,-r*.3,r*.22,r*.16,-.3,0,Math.PI*2);ctx.fill();

  ctx.restore();
}

// â•â•â• Draw Obstacle â•â•â•
function drawObstacle(ob){
  ctx.save();ctx.translate(ob.x,ob.y);
  if(ob.type==='rock'){
    ctx.fillStyle='#8d8d8d';ctx.beginPath();ctx.ellipse(0,0,ob.radius,ob.radius*.75,0,0,Math.PI*2);ctx.fill();
    ctx.fillStyle='#a0a0a0';ctx.beginPath();ctx.ellipse(-4,-4,ob.radius*.7,ob.radius*.5,.2,0,Math.PI*2);ctx.fill();
    ctx.fillStyle='rgba(255,255,255,.1)';ctx.beginPath();ctx.ellipse(-ob.radius*.2,-ob.radius*.25,ob.radius*.3,ob.radius*.2,-.2,0,Math.PI*2);ctx.fill();
  }else if(ob.type==='log'){
    ctx.fillStyle='#795548';ctx.beginPath();ctx.ellipse(0,0,ob.radius*1.2,ob.radius*.5,0,0,Math.PI*2);ctx.fill();
    ctx.fillStyle='#8d6e63';ctx.beginPath();ctx.ellipse(0,-3,ob.radius,ob.radius*.35,0,0,Math.PI*2);ctx.fill();
    ctx.strokeStyle='rgba(0,0,0,.1)';ctx.lineWidth=1;ctx.beginPath();ctx.ellipse(0,-3,ob.radius*.4,ob.radius*.15,0,0,Math.PI*2);ctx.stroke();
  }else{
    ctx.fillStyle='#558b2f';ctx.beginPath();ctx.arc(0,0,ob.radius,0,Math.PI*2);ctx.fill();
    ctx.fillStyle='#7cb342';ctx.beginPath();ctx.arc(-5,-5,ob.radius*.7,0,Math.PI*2);ctx.fill();
    ctx.fillStyle='#9ccc65';ctx.beginPath();ctx.arc(3,-8,ob.radius*.4,0,Math.PI*2);ctx.fill();
  }
  ctx.restore();
}

// â•â•â• Update â•â•â•
function update(){
  for(const a of animals){
    a.wobble+=.04;
    if(a.bounce>0)a.bounce*=.9;
    if(a.happy>0)a.happy-=.01;
    a.danger*=.93;
  }

  if(phase!=='exec')return;
  execTimer++;

  // Timer activation
  for(const em of emitters){
    if(em.active||em.fired)continue;
    if(em.timerSec>0&&execTimer>=em.timerSec*60){
      em.active=true;em.age=0;
      if(em.type==='push'){
        ripples.push({x:em.x,y:em.y,radius:0,maxRadius:em.range,alpha:1,force:em.power});
        em.fired=true;em.active=false;em.roarBounce=1;sndRoar();
      }
      snd(400,.12);
    }
  }

  // Pull emitters
  for(const em of emitters){
    if(!em.active||em.type!=='pull')continue;
    em.age++;
    if(em.age>(em.duration||240)){em.active=false;continue;}
    const str=em.power*(1-em.age/(em.duration||240));
    for(const a of animals){
      const dx=em.x-a.x,dy=em.y-a.y,dist=Math.sqrt(dx*dx+dy*dy);
      if(dist>5&&dist<em.range){
        const f=str*((em.range-dist)/em.range)/(dist*.22);
        a.vx+=dx/dist*f;a.vy+=dy/dist*f;
      }
    }
    if(em.age%4===0){
      const ang=em.age*.15,rd=50+Math.random()*40;
      particles.push({x:em.x+Math.cos(ang)*rd,y:em.y+Math.sin(ang)*rd,vx:-Math.cos(ang)*rd*.025,vy:-Math.sin(ang)*rd*.025,life:.6,color:'rgba(233,30,99,',size:2+Math.random()*2});
    }
  }

  // Push ripples
  for(let i=ripples.length-1;i>=0;i--){
    const r=ripples[i];r.radius+=5;r.alpha=Math.max(0,1-r.radius/r.maxRadius);
    for(const a of animals){
      const dx=a.x-r.x,dy=a.y-r.y,dist=Math.sqrt(dx*dx+dy*dy);
      if(dist>0&&Math.abs(dist-r.radius)<24){
        const intensity=1-Math.abs(dist-r.radius)/24;
        const f=r.force*r.alpha*intensity;
        a.vx+=dx/dist*f;a.vy+=dy/dist*f;
      }
    }
    if(r.radius>=r.maxRadius)ripples.splice(i,1);
  }

  // Fade age for push emitters
  for(const em of emitters){
    if(em.fired&&em.type==='push')em.fadeAge++;
    if(em.roarBounce>0)em.roarBounce*=.9;
  }

  // Animal physics
  for(const a of animals){
    a.vx*=FRICTION;a.vy*=FRICTION;
    a.x+=a.vx;a.y+=a.vy;
    const m=14;
    if(a.x-a.radius<m){a.x=m+a.radius;a.vx=Math.abs(a.vx)*.5;a.bounce=1;sndBounce();}
    if(a.x+a.radius>W-m){a.x=W-m-a.radius;a.vx=-Math.abs(a.vx)*.5;a.bounce=1;sndBounce();}
    if(a.y-a.radius<60){a.y=60+a.radius;a.vy=Math.abs(a.vy)*.5;a.bounce=1;}
    if(a.y+a.radius>H-14){a.y=H-14-a.radius;a.vy=-Math.abs(a.vy)*.5;a.bounce=1;}
    for(const ob of obstacles){
      const dx=a.x-ob.x,dy=a.y-ob.y,dist=Math.sqrt(dx*dx+dy*dy);
      const minD=a.radius+ob.radius;
      if(dist<minD&&dist>0){
        const overlap=minD-dist;
        a.x+=dx/dist*overlap;a.y+=dy/dist*overlap;
        const dot=a.vx*(dx/dist)+a.vy*(dy/dist);
        a.vx-=2*dot*(dx/dist)*.5;a.vy-=2*dot*(dy/dist)*.5;
        a.bounce=1;sndBounce();
      }
    }
  }

  // Collisions
  for(let i=0;i<animals.length;i++){
    for(let j=i+1;j<animals.length;j++){
      const a=animals[i],b=animals[j];
      const dx=a.x-b.x,dy=a.y-b.y,dist=Math.sqrt(dx*dx+dy*dy),minD=a.radius+b.radius;

      if(a.type===b.type){
        if(dist<minD-3){
          const mx=(a.x+b.x)/2,my=(a.y+b.y)/2;
          const nm=Math.max(a.mergeCount,b.mergeCount)+1;
          comboCount++;const pts=200*comboCount;score+=pts;
          flashes.push({x:mx,y:my,radius:0,maxRadius:80,alpha:1,color:ANIMALS[a.type].bodyColor});
          ripples.push({x:mx,y:my,radius:0,maxRadius:80+nm*18,alpha:.4,force:2.5});
          for(let p=0;p<12;p++){
            const ang=(Math.PI*2/12)*p,sp=2+Math.random()*3;
            particles.push({x:mx,y:my,vx:Math.cos(ang)*sp,vy:Math.sin(ang)*sp,life:1,color:'rgba(255,215,0,',size:3+Math.random()*3});
          }
          for(let p=0;p<4;p++){
            particles.push({x:mx+(Math.random()-.5)*30,y:my-10,vx:(Math.random()-.5)*1.5,vy:-1.5-Math.random(),life:1.5,isHeart:true,size:8+Math.random()*4,color:'#e91e63'});
          }
          particles.push({x:mx,y:my-20,vx:0,vy:-1,life:1.8,isText:true,text:`+${pts}`,color:'rgba(255,255,255,'});
          const wasCount=animals.filter(o=>o.type===a.type).length;
          const newA={x:mx,y:my,vx:(a.vx+b.vx)*.2,vy:(a.vy+b.vy)*.2,
            radius:ORB_R+nm*3.5,type:a.type,mergeCount:nm,
            blink:200,blinkTimer:200,bounce:1,danger:0,wobble:0,happy:1};
          animals.splice(j,1);animals.splice(i,1);animals.push(newA);
          sndMerge(comboCount);
          if(wasCount===2){
            particles.push({x:mx,y:my-40,vx:0,vy:-.6,life:2.2,isText:true,text:`${ANIMALS[newA.type].emoji} ${ANIMALS[newA.type].name} ì™„ì„±!`,color:'rgba(255,215,0,'});
            snd(880,.2,'sine',.08);
          }
          updateAllUI();i=-1;break;
        }
      }else{
        const aDone=animals.filter(o=>o.type===a.type).length<=1;
        const bDone=animals.filter(o=>o.type===b.type).length<=1;
        if(dist<minD*.7){
          if(!aDone||!bDone){
            phase='done';collisionPt={x:(a.x+b.x)/2,y:(a.y+b.y)/2};
            shakeT=22;sndDeath();
            for(let p=0;p<20;p++){
              const ang=Math.random()*Math.PI*2,sp=2+Math.random()*4;
              particles.push({x:collisionPt.x,y:collisionPt.y,vx:Math.cos(ang)*sp,vy:Math.sin(ang)*sp,life:1.3,color:'rgba(255,100,100,',size:3+Math.random()*4});
            }
            setTimeout(()=>{
              document.getElementById('goReason').textContent=`${ANIMALS[a.type].emoji}${ANIMALS[a.type].name}ê³¼ ${ANIMALS[b.type].emoji}${ANIMALS[b.type].name}ì´ ë¶€ë”ªí˜”ì–´ìš”!`;
              document.getElementById('gameOver').style.display='flex';
            },600);
            return;
          }else{
            const overlap=minD-dist,nx=dx/dist,ny=dy/dist;
            a.x+=nx*overlap*.5;a.y+=ny*overlap*.5;
            b.x-=nx*overlap*.5;b.y-=ny*overlap*.5;
            const rv=(a.vx-b.vx)*nx+(a.vy-b.vy)*ny;
            if(rv>0){a.vx-=rv*nx*.5;a.vy-=rv*ny*.5;b.vx+=rv*nx*.5;b.vy+=rv*ny*.5;}
          }
        }
        if(dist<90&&(!aDone||!bDone)){
          const d=Math.max(0,1-(dist-minD)/(90-minD));
          a.danger=Math.max(a.danger,d);b.danger=Math.max(b.danger,d);
        }
        if(dist<minD*1.1&&dist>0&&(!aDone||!bDone)){
          const push=(minD*1.1-dist)*.1;
          a.vx+=dx/dist*push;a.vy+=dy/dist*push;
          b.vx-=dx/dist*push;b.vy-=dy/dist*push;
        }
      }
    }
  }

  // Win check
  const cfg=LEVELS[Math.min(level-1,LEVELS.length-1)];
  let allDone=true;
  for(let a=0;a<cfg.a;a++)if(animals.filter(o=>o.type===a).length>1){allDone=false;break;}
  if(allDone){phase='done';setTimeout(()=>showClear(),500);return;}

  // Settled fail
  const allEmDone=emitters.every(e=>!e.active);
  const allStill=animals.every(o=>Math.abs(o.vx)<.25&&Math.abs(o.vy)<.25);
  if(allEmDone&&ripples.length===0&&allStill){
    settledTimer++;
    if(settledTimer>80){
      phase='done';sndDeath();
      setTimeout(()=>{
        document.getElementById('goReason').textContent='ë™ë¬¼ë“¤ì´ ë©ˆì·„ì§€ë§Œ ì•„ì§ ë‹¤ ëª¨ì´ì§€ ì•Šì•˜ì–´ìš”!';
        document.getElementById('gameOver').style.display='flex';
      },400);
    }
  }else settledTimer=0;

  if(shakeT>0){shakeT--;shakeX=(Math.random()-.5)*shakeT*1.2;shakeY=(Math.random()-.5)*shakeT*1.2;}
  else{shakeX=shakeY=0;}

  for(let i=particles.length-1;i>=0;i--){
    const p=particles[i];p.x+=p.vx||0;p.y+=p.vy||0;
    if(p.isHeart)p.vy-=.01;
    p.life-=.016;if(p.life<=0)particles.splice(i,1);
  }
  for(let i=flashes.length-1;i>=0;i--){
    flashes[i].radius+=3;flashes[i].alpha-=.03;
    if(flashes[i].alpha<=0)flashes.splice(i,1);
  }
}

// â•â•â• Draw â•â•â•
function draw(){
  ctx.save();ctx.translate(shakeX,shakeY);

  // Forest BG
  const bg=ctx.createLinearGradient(0,0,0,H);
  bg.addColorStop(0,'#4a7c2e');bg.addColorStop(.3,'#3d6b25');bg.addColorStop(.7,'#2d5a1b');bg.addColorStop(1,'#1e4210');
  ctx.fillStyle=bg;ctx.fillRect(-20,-20,W+40,H+40);

  for(const g of grassTufts){
    ctx.strokeStyle=`rgba(100,180,60,${.15*g.s})`;ctx.lineWidth=1.5;ctx.lineCap='round';
    ctx.beginPath();ctx.moveTo(g.x,g.y);ctx.lineTo(g.x+Math.cos(g.r-1)*6*g.s,g.y-8*g.s);ctx.stroke();
    ctx.beginPath();ctx.moveTo(g.x,g.y);ctx.lineTo(g.x+Math.cos(g.r+.5)*5*g.s,g.y-7*g.s);ctx.stroke();
  }

  const t=Date.now()*.001;
  for(const f of flowers){
    const sway=Math.sin(t+f.p)*.02;
    ctx.save();ctx.translate(f.x,f.y);ctx.rotate(sway);ctx.fillStyle=f.c;
    for(let p=0;p<5;p++){const a=(Math.PI*2/5)*p;ctx.beginPath();ctx.ellipse(Math.cos(a)*4*f.s,Math.sin(a)*4*f.s,3*f.s,2*f.s,a,0,Math.PI*2);ctx.fill();}
    ctx.fillStyle='#fff176';ctx.beginPath();ctx.arc(0,0,2*f.s,0,Math.PI*2);ctx.fill();ctx.restore();
  }

  for(const tr of trees){
    ctx.fillStyle='#5d4037';ctx.fillRect(tr.x-4*tr.s,tr.y-10*tr.s,8*tr.s,20*tr.s);
    ctx.fillStyle='rgba(46,125,50,.25)';ctx.beginPath();ctx.arc(tr.x,tr.y-20*tr.s,18*tr.s,0,Math.PI*2);ctx.fill();
    ctx.fillStyle='rgba(56,142,60,.2)';
    ctx.beginPath();ctx.arc(tr.x-8*tr.s,tr.y-14*tr.s,12*tr.s,0,Math.PI*2);ctx.fill();
    ctx.beginPath();ctx.arc(tr.x+10*tr.s,tr.y-16*tr.s,13*tr.s,0,Math.PI*2);ctx.fill();
  }

  for(const ob of obstacles)drawObstacle(ob);

  // â”€â”€ Draw Emitters (placed item animals) â”€â”€
  for(const em of emitters){
    const isPull=em.type==='pull';
    const bc=isPull?'233,30,99':'69,90,100';
    let alpha=1;
    if(phase==='exec'&&em.active&&isPull)alpha=Math.max(.2,1-em.age/(em.duration||240));
    if(phase==='exec'&&em.fired&&em.type==='push')alpha=Math.max(.1,1-em.fadeAge/80);
    if(phase==='exec'&&!em.active&&em.fired&&em.type==='push'&&em.fadeAge>80)alpha=.1;

    // Timer countdown (waiting)
    if(phase==='exec'&&!em.active&&!em.fired&&em.timerSec>0){
      const remaining=Math.max(0,em.timerSec-execTimer/60);
      drawAnimal({x:em.x,y:em.y,radius:16,type:em.animalIdx,mergeCount:0,blinkTimer:Infinity,bounce:0,danger:0,wobble:Date.now()*.002,happy:0},{isComplete:false,baseAlpha:.45});
      ctx.fillStyle='rgba(255,152,0,.85)';ctx.font='bold 13px sans-serif';ctx.textAlign='center';
      ctx.fillText(`${remaining.toFixed(1)}s`,em.x,em.y+28);
      continue;
    }

    // Range circle
    ctx.strokeStyle=`rgba(${bc},${.08*alpha})`;ctx.lineWidth=1;ctx.setLineDash([5,5]);
    ctx.beginPath();ctx.arc(em.x,em.y,em.range,0,Math.PI*2);ctx.stroke();ctx.setLineDash([]);

    // Aura glow
    const glow=ctx.createRadialGradient(em.x,em.y,14,em.x,em.y,40);
    glow.addColorStop(0,`rgba(${bc},${.2*alpha})`);glow.addColorStop(1,'rgba(0,0,0,0)');
    ctx.fillStyle=glow;ctx.beginPath();ctx.arc(em.x,em.y,40,0,Math.PI*2);ctx.fill();

    // Draw item animal
    const emR=16*(1+(em.roarBounce||0)*.4);
    drawAnimal({x:em.x,y:em.y,radius:emR,type:em.animalIdx,mergeCount:0,blinkTimer:Infinity,bounce:0,danger:0,wobble:Date.now()*.002,happy:isPull?.5:0},{isComplete:false,baseAlpha:alpha});

    // Timer badge on placed animal
    if(em.timerSec>0&&phase==='plan'){
      ctx.fillStyle='rgba(255,152,0,.9)';
      const bx=em.x+14,by=em.y-14;
      ctx.beginPath();ctx.arc(bx,by,10,0,Math.PI*2);ctx.fill();
      ctx.fillStyle='#fff';ctx.font='bold 10px sans-serif';ctx.textAlign='center';ctx.textBaseline='middle';
      ctx.fillText(`${em.timerSec}s`,bx,by);ctx.textBaseline='alphabetic';
    }

    // Pull rings
    if(phase==='exec'&&em.active&&isPull){
      for(let ring=0;ring<3;ring++){
        const progress=((em.age*2+ring*40)%120);
        const ringR=em.range-progress*(em.range/120);
        if(ringR<14)continue;
        ctx.strokeStyle=`rgba(233,30,99,${.08*(ringR/em.range)*alpha})`;ctx.lineWidth=1.2;
        ctx.beginPath();ctx.arc(em.x,em.y,ringR,0,Math.PI*2);ctx.stroke();
      }
    }

    // Label
    ctx.fillStyle=`rgba(255,255,255,${.35*alpha})`;ctx.font='10px sans-serif';ctx.textAlign='center';
    ctx.fillText(isPull?'ëŒê¸°':'ë°€ê¸°',em.x,em.y+emR+14);
  }

  // Ghost preview
  if(phase==='plan'&&ghostPos&&selectedItem){
    const it=ITEM_TYPES[selectedItem];
    if(it&&it.type!=='timer'&&ghostPos.y>95&&ghostPos.y<H-100){
      const isPull=it.type==='pull';
      const bc=isPull?'233,30,99':'69,90,100';
      // Range fill
      const gf=ctx.createRadialGradient(ghostPos.x,ghostPos.y,0,ghostPos.x,ghostPos.y,it.range);
      gf.addColorStop(0,`rgba(${bc},.08)`);gf.addColorStop(.7,`rgba(${bc},.05)`);gf.addColorStop(1,`rgba(${bc},0)`);
      ctx.fillStyle=gf;ctx.beginPath();ctx.arc(ghostPos.x,ghostPos.y,it.range,0,Math.PI*2);ctx.fill();
      // Range stroke
      ctx.strokeStyle=`rgba(${bc},.25)`;ctx.lineWidth=1.5;ctx.setLineDash([6,4]);
      ctx.beginPath();ctx.arc(ghostPos.x,ghostPos.y,it.range,0,Math.PI*2);ctx.stroke();ctx.setLineDash([]);
      // Ghost animal
      drawAnimal({x:ghostPos.x,y:ghostPos.y,radius:14,type:it.animalIdx,mergeCount:0,blinkTimer:Infinity,bounce:0,danger:0,wobble:0,happy:0},{isComplete:false,baseAlpha:.3});
    }
  }

  // Ripples
  for(const r of ripples){
    ctx.strokeStyle=`rgba(100,200,255,${r.alpha*.45})`;ctx.lineWidth=2.5;
    ctx.beginPath();ctx.arc(r.x,r.y,r.radius,0,Math.PI*2);ctx.stroke();
  }

  // Flashes
  for(const f of flashes){
    const g=ctx.createRadialGradient(f.x,f.y,0,f.x,f.y,f.radius);
    g.addColorStop(0,`rgba(255,255,200,${f.alpha*.4})`);g.addColorStop(1,'rgba(0,0,0,0)');
    ctx.fillStyle=g;ctx.beginPath();ctx.arc(f.x,f.y,f.radius,0,Math.PI*2);ctx.fill();
  }

  // Board Animals
  const sorted=[...animals].sort((a,b)=>a.y-b.y);
  for(const a of sorted)drawAnimal(a);

  // Collision point
  if(collisionPt){
    const flash=Math.sin(Date.now()*.01)*.5+.5;
    const eg=ctx.createRadialGradient(collisionPt.x,collisionPt.y,0,collisionPt.x,collisionPt.y,60);
    eg.addColorStop(0,`rgba(255,50,50,${.3*flash})`);eg.addColorStop(1,'rgba(0,0,0,0)');
    ctx.fillStyle=eg;ctx.beginPath();ctx.arc(collisionPt.x,collisionPt.y,60,0,Math.PI*2);ctx.fill();
  }

  // Particles
  for(const p of particles){
    const a=Math.min(1,p.life);
    if(p.isText){
      ctx.fillStyle=`${p.color}${a})`;ctx.font=`bold ${p.text.includes('ì™„ì„±')?18:16}px sans-serif`;
      ctx.textAlign='center';ctx.fillText(p.text,p.x,p.y);
    }else if(p.isHeart){
      ctx.fillStyle=p.color;ctx.globalAlpha=a;ctx.font=`${p.size}px sans-serif`;
      ctx.textAlign='center';ctx.fillText('â¤ï¸',p.x,p.y);ctx.globalAlpha=1;
    }else{
      ctx.fillStyle=`${p.color}${a})`;ctx.beginPath();ctx.arc(p.x,p.y,p.size*a,0,Math.PI*2);ctx.fill();
    }
  }

  if(comboCount>1){
    ctx.fillStyle=`rgba(255,215,0,${Math.min(1,comboCount*.25)})`;
    ctx.font='bold 32px sans-serif';ctx.textAlign='center';
    ctx.fillText(`${comboCount}x COMBO!`,W/2,H/2-50);
  }

  ctx.restore();
}

function gameLoop(){update();draw();requestAnimationFrame(gameLoop);}

// â•â•â• Clear + Reward Selection â•â•â•
function showClear(){
  const cfg=LEVELS[Math.min(level-1,LEVELS.length-1)];
  const used=emitters.length;
  let stars=1;
  if(used<=cfg.par)stars=3;else if(used<=cfg.par+1)stars=2;

  // Unused items carry over
  const unusedItems={};let unusedCount=0;
  for(const[key,total]of Object.entries(inventory)){
    const it=ITEM_TYPES[key];
    let usedOfThis;
    if(it.type==='timer') usedOfThis=emitters.filter(e=>e.timerKey===key).length;
    else usedOfThis=emitters.filter(e=>e.itemKey===key).length;
    const rem=total-usedOfThis;
    if(rem>0){unusedItems[key]=rem;unusedCount+=rem;}
  }

  const coinReward=stars*3+comboCount*2;
  coins+=coinReward;
  score+=unusedCount*150;
  totalScore+=score;

  window._bonusItems={...unusedItems};

  // Reward options: merged animal types + random timer
  const rewardOptions=[];
  for(let a=0;a<cfg.a;a++){
    if(animals.filter(o=>o.type===a).length<=1){
      const itemKey=Object.keys(ITEM_TYPES).find(k=>ITEM_TYPES[k].animalIdx===a&&ITEM_TYPES[k].type==='pull');
      if(itemKey)rewardOptions.push(itemKey);
    }
  }
  // Random timer
  if(Math.random()<.4+level*.06){
    const tk=['timer1','timer2','timer3'];
    rewardOptions.push(tk[Math.floor(Math.random()*tk.length)]);
  }

  document.getElementById('lcStars').textContent='â˜…'.repeat(stars)+'â˜†'.repeat(3-stars);
  document.getElementById('lcTitle').textContent=`ìˆ² ${level} í´ë¦¬ì–´! ğŸŒ³`;
  document.getElementById('lcInfo').textContent=`ì•„ì´í…œ ${used}ê°œ ì‚¬ìš© (ê¸°ì¤€: ${cfg.par}ê°œ) | ì ìˆ˜: ${score} | ğŸŒ° +${coinReward}`;

  let optH='';
  for(const key of rewardOptions){
    const it=ITEM_TYPES[key];
    if(it.type==='timer'){
      optH+=`<div class="reward-opt" onclick="pickReward('${key}',this)">
        <span class="r-emoji">â±ï¸</span><span class="r-name">${it.seconds}ì´ˆ íƒ€ì´ë¨¸</span>
        <span class="r-desc">ì§€ì—° ë°œë™</span></div>`;
    }else{
      const info=ANIMALS[it.animalIdx];
      optH+=`<div class="reward-opt" onclick="pickReward('${key}',this)">
        <span class="r-emoji">${info.emoji}</span><span class="r-name">${info.name}</span>
        <span class="r-desc">ëŒê¸° ${it.range}</span></div>`;
    }
  }
  document.getElementById('rewardOptions').innerHTML=optH;
  document.getElementById('lcBonus').textContent=unusedCount>0?`ğŸ’« ë¯¸ì‚¬ìš© ì•„ì´í…œ ${unusedCount}ê°œ â†’ ë‹¤ìŒ ìˆ²ìœ¼ë¡œ ì´ì›”!`:'';
  document.getElementById('lcBtns').style.display='none';
  document.getElementById('levelClear').style.display='flex';
  sndWin();
}

function pickReward(key,el){
  window._bonusItems=window._bonusItems||{};
  window._bonusItems[key]=(window._bonusItems[key]||0)+1;
  document.querySelectorAll('.reward-opt').forEach(o=>{o.classList.remove('picked');o.style.opacity='.3';o.style.pointerEvents='none';});
  el.classList.add('picked');el.style.opacity='1';
  document.getElementById('lcBtns').style.display='flex';
  snd(880,.15,'sine',.08);
}

// â•â•â• Game Flow â•â•â•
function startGame(){hideAll();level=1;totalScore=0;coins=0;window._bonusItems=null;initLevel(level);}
function nextLevel(){hideAll();level++;initLevel(level);}
function retryLevel(){hideAll();collisionPt=null;initLevel(level);}
function hideAll(){['startScreen','gameOver','levelClear'].forEach(id=>document.getElementById(id).style.display='none');}

gameLoop();
</script>
</body>
</html>
