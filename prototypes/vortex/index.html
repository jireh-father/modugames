<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>소용돌이 (Vortex)</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{background:#1a0a0a;overflow:hidden;touch-action:none;font-family:'Segoe UI',sans-serif;user-select:none}
canvas{display:block}
#ui{position:fixed;top:0;left:0;right:0;display:flex;justify-content:space-between;align-items:center;padding:12px 16px;pointer-events:none;z-index:10}
#ui>div{background:rgba(0,0,0,0.5);padding:8px 16px;border-radius:20px;font-size:15px;color:#ffab91;font-weight:bold}
#startScreen{position:fixed;inset:0;background:linear-gradient(180deg,#1a0a0a 0%,#bf360c 50%,#1a0a0a 100%);display:flex;flex-direction:column;align-items:center;justify-content:center;color:#fff;z-index:100}
#startScreen h1{font-size:48px;margin-bottom:8px;background:linear-gradient(90deg,#ffab91,#ff8a65,#ff5722);-webkit-background-clip:text;-webkit-text-fill-color:transparent}
#startScreen p{color:#ffab91;margin-bottom:30px;font-size:16px;text-align:center;line-height:1.6}
#startScreen button{background:linear-gradient(135deg,#bf360c,#ff5722);color:#fff;border:none;padding:16px 48px;border-radius:30px;font-size:20px;cursor:pointer;font-weight:bold;box-shadow:0 4px 20px rgba(255,87,34,0.5)}
#levelComplete{position:fixed;inset:0;background:rgba(26,10,10,0.95);display:none;flex-direction:column;align-items:center;justify-content:center;color:#fff;z-index:100}
#levelComplete h2{font-size:32px;margin-bottom:12px}
#lcStars{font-size:48px;color:#ffd54f;margin-bottom:8px}
#lcInfo{font-size:18px;color:#ffab91;margin-bottom:24px}
#levelComplete button{background:linear-gradient(135deg,#bf360c,#ff5722);color:#fff;border:none;padding:14px 36px;border-radius:30px;font-size:18px;cursor:pointer;font-weight:bold;margin:6px}
#skillInfo{position:fixed;bottom:16px;left:50%;transform:translateX(-50%);background:rgba(191,54,12,0.4);padding:10px 24px;border-radius:20px;color:#ffccbc;font-size:14px;pointer-events:none;z-index:10}
</style>
</head>
<body>
<div id="startScreen">
  <h1>소용돌이</h1>
  <p>스와이프로 토네이도 경로를 그리세요!<br>토네이도가 경로를 따라 이동하며<br>구슬을 빨아들여 합쳐요!</p>
  <button onclick="startGame()">시작하기</button>
</div>
<div id="ui">
  <div id="levelDisplay">레벨 1</div>
  <div id="scoreDisplay">점수: 0</div>
  <div id="swipeDisplay">스와이프: 0</div>
</div>
<div id="skillInfo">스와이프로 토네이도 경로를 그리세요!</div>
<div id="levelComplete">
  <h2 id="lcTitle">레벨 클리어!</h2>
  <div id="lcStars"></div>
  <div id="lcInfo"></div>
  <button onclick="nextLevel()">다음 레벨</button>
  <button onclick="retryLevel()">다시 도전</button>
</div>
<canvas id="c"></canvas>
<script>
const canvas=document.getElementById('c'),ctx=canvas.getContext('2d');
let W,H;
function resize(){W=canvas.width=window.innerWidth;H=canvas.height=window.innerHeight}
resize();window.addEventListener('resize',resize);

const audioCtx=new(window.AudioContext||window.webkitAudioContext)();
function playSound(f,d,t='sine',v=0.12){const o=audioCtx.createOscillator(),g=audioCtx.createGain();o.type=t;o.frequency.value=f;g.gain.setValueAtTime(v,audioCtx.currentTime);g.gain.exponentialRampToValueAtTime(0.001,audioCtx.currentTime+d);o.connect(g);g.connect(audioCtx.destination);o.start();o.stop(audioCtx.currentTime+d)}
function playVortex(){playSound(150,0.2,'sawtooth',0.06);playSound(200,0.15,'sine',0.04)}
function playMerge(c){const b=400+c*80;playSound(b,0.5,'sine',0.2);playSound(b*1.5,0.3,'sine',0.1)}
function playSuck(){playSound(100,0.1,'sine',0.04)}

const COLORS=[
  {fill:'#ef5350',glow:'rgba(239,83,80,'},
  {fill:'#42a5f5',glow:'rgba(66,165,245,'},
  {fill:'#66bb6a',glow:'rgba(102,187,106,'},
  {fill:'#ffa726',glow:'rgba(255,167,38,'},
  {fill:'#ab47bc',glow:'rgba(171,71,188,'},
];

let orbs=[],particles=[],flashes=[];
let tornado=null; // active tornado traveling along path
let swipePath=[]; // current swipe drawing
let isDrawing=false;
let swipeCount=0,score=0,totalScore=0,level=1,gameActive=false,comboCount=0;

const FRICTION=0.985,ORB_RADIUS=22;
const TORNADO_SPEED=5,TORNADO_RADIUS=70,TORNADO_FORCE=2.5;

const levels=[
  {colors:2,perColor:2,par:2},{colors:2,perColor:3,par:2},
  {colors:3,perColor:2,par:2},{colors:3,perColor:3,par:3},
  {colors:4,perColor:2,par:3},{colors:4,perColor:3,par:3},
  {colors:3,perColor:4,par:3},{colors:5,perColor:2,par:4},
];

function initLevel(l){
  const cfg=levels[Math.min(l-1,levels.length-1)];
  orbs=[];particles=[];flashes=[];tornado=null;swipePath=[];
  swipeCount=0;score=0;comboCount=0;isDrawing=false;
  const margin=80;
  for(let c=0;c<cfg.colors;c++){
    for(let n=0;n<cfg.perColor;n++){
      let x,y,ok,att=0;
      do{x=margin+Math.random()*(W-margin*2);y=margin+60+Math.random()*(H-margin*2-120);ok=true;
        for(const o of orbs){const dx=x-o.x,dy=y-o.y;if(Math.sqrt(dx*dx+dy*dy)<ORB_RADIUS*3.5){ok=false;break}}att++}while(!ok&&att<100);
      orbs.push({x,y,vx:0,vy:0,radius:ORB_RADIUS,color:c,mergeCount:0,pulse:Math.random()*Math.PI*2,
        spinning:false,spinAngle:0,spinRadius:0,spinCenter:null});
    }
  }
  updateUI();
}

function updateUI(){
  document.getElementById('levelDisplay').textContent=`레벨 ${level}`;
  document.getElementById('scoreDisplay').textContent=`점수: ${totalScore+score}`;
  document.getElementById('swipeDisplay').textContent=`스와이프: ${swipeCount}`;
}

// Input
canvas.addEventListener('pointerdown',e=>{
  e.preventDefault();if(!gameActive||tornado)return;
  isDrawing=true;swipePath=[{x:e.clientX,y:e.clientY}];
});
canvas.addEventListener('pointermove',e=>{
  e.preventDefault();
  if(!isDrawing)return;
  const last=swipePath[swipePath.length-1];
  const dx=e.clientX-last.x,dy=e.clientY-last.y;
  if(Math.sqrt(dx*dx+dy*dy)>10){
    swipePath.push({x:e.clientX,y:e.clientY});
  }
});
canvas.addEventListener('pointerup',e=>{
  e.preventDefault();
  if(!isDrawing)return;
  isDrawing=false;
  if(swipePath.length>=3){
    // Simplify path
    const simplified=[];
    for(let i=0;i<swipePath.length;i+=2)simplified.push(swipePath[i]);
    if(simplified[simplified.length-1]!==swipePath[swipePath.length-1])simplified.push(swipePath[swipePath.length-1]);

    tornado={path:simplified,pathIndex:0,progress:0,x:simplified[0].x,y:simplified[0].y,
      rotation:0,particles:[],active:true,age:0};
    swipeCount++;comboCount=0;
    playVortex();updateUI();
  }
  swipePath=[];
});

function update(){
  // Update tornado
  if(tornado&&tornado.active){
    tornado.age++;tornado.rotation+=0.15;
    // Move along path
    const path=tornado.path;
    if(tornado.pathIndex<path.length-1){
      const from=path[tornado.pathIndex],to=path[tornado.pathIndex+1];
      const dx=to.x-from.x,dy=to.y-from.y;
      const segLen=Math.sqrt(dx*dx+dy*dy);
      tornado.progress+=TORNADO_SPEED;
      if(tornado.progress>=segLen){
        tornado.progress-=segLen;
        tornado.pathIndex++;
      }
      if(tornado.pathIndex<path.length-1){
        const f2=path[tornado.pathIndex],t2=path[tornado.pathIndex+1];
        const dx2=t2.x-f2.x,dy2=t2.y-f2.y;
        const sl2=Math.sqrt(dx2*dx2+dy2*dy2);
        const t=sl2>0?tornado.progress/sl2:0;
        tornado.x=f2.x+dx2*t;
        tornado.y=f2.y+dy2*t;
      }
    } else {
      tornado.active=false;
    }

    // Pull orbs toward tornado center (vortex effect)
    if(tornado.active){
      for(const orb of orbs){
        const dx=tornado.x-orb.x,dy=tornado.y-orb.y;
        const dist=Math.sqrt(dx*dx+dy*dy);
        if(dist<TORNADO_RADIUS&&dist>5){
          // Pull toward center
          const pullForce=TORNADO_FORCE*(1-dist/TORNADO_RADIUS);
          orb.vx+=dx/dist*pullForce;
          orb.vy+=dy/dist*pullForce;
          // Spin tangentially
          const tangX=-dy/dist,tangY=dx/dist;
          orb.vx+=tangX*pullForce*0.5;
          orb.vy+=tangY*pullForce*0.5;
          if(tornado.age%10===0)playSuck();
        }
      }
    }

    // Tornado particles
    if(tornado.age%2===0){
      for(let i=0;i<3;i++){
        const angle=tornado.rotation+i*Math.PI*2/3;
        const r=20+Math.random()*40;
        particles.push({
          x:tornado.x+Math.cos(angle)*r,y:tornado.y+Math.sin(angle)*r,
          vx:(Math.random()-0.5)*2,vy:-1-Math.random()*2,
          life:0.8,color:'rgba(255,171,145,',size:3+Math.random()*3
        });
      }
    }
  }

  // Update orbs
  for(const orb of orbs){
    orb.x+=orb.vx;orb.y+=orb.vy;orb.vx*=FRICTION;orb.vy*=FRICTION;orb.pulse+=0.03;
    const m=10;
    if(orb.x-orb.radius<m){orb.x=m+orb.radius;orb.vx=Math.abs(orb.vx)*0.7}
    if(orb.x+orb.radius>W-m){orb.x=W-m-orb.radius;orb.vx=-Math.abs(orb.vx)*0.7}
    if(orb.y-orb.radius<m+50){orb.y=m+50+orb.radius;orb.vy=Math.abs(orb.vy)*0.7}
    if(orb.y+orb.radius>H-m-40){orb.y=H-m-40-orb.radius;orb.vy=-Math.abs(orb.vy)*0.7}
    for(const o2 of orbs){
      if(o2===orb)continue;
      const dx=orb.x-o2.x,dy=orb.y-o2.y,dist=Math.sqrt(dx*dx+dy*dy);
      if(dist<orb.radius+o2.radius&&dist>0&&orb.color!==o2.color){
        const push=(orb.radius+o2.radius-dist)*0.3;
        orb.vx+=dx/dist*push;orb.vy+=dy/dist*push;
      }
    }
  }

  // Check merges
  for(let i=orbs.length-1;i>=0;i--){
    for(let j=i-1;j>=0;j--){
      if(i>=orbs.length||j>=orbs.length)continue;
      const a=orbs[i],b=orbs[j];if(!a||!b||a.color!==b.color)continue;
      const dx=a.x-b.x,dy=a.y-b.y,dist=Math.sqrt(dx*dx+dy*dy);
      if(dist<a.radius+b.radius-5){
        const nx=(a.x+b.x)/2,ny=(a.y+b.y)/2;
        const nm=Math.max(a.mergeCount,b.mergeCount)+1;
        comboCount++;const pts=100*comboCount;score+=pts;
        flashes.push({x:nx,y:ny,radius:0,maxRadius:80,alpha:1,color:COLORS[a.color].glow});
        for(let p=0;p<14;p++){const ang=(Math.PI*2/14)*p,spd=2+Math.random()*3;
          particles.push({x:nx,y:ny,vx:Math.cos(ang)*spd,vy:Math.sin(ang)*spd,life:1,color:COLORS[a.color].glow,size:4+Math.random()*3})}
        particles.push({x:nx,y:ny-20,vx:0,vy:-1,life:1.5,color:'rgba(255,255,255,',size:0,text:`+${pts}`,isText:true});
        orbs.splice(i,1);
        orbs[j]={x:nx,y:ny,vx:(a.vx+b.vx)*0.3,vy:(a.vy+b.vy)*0.3,radius:ORB_RADIUS+nm*5,color:a.color,mergeCount:nm,pulse:0,spinning:false,spinAngle:0,spinRadius:0,spinCenter:null};
        playMerge(comboCount);updateUI();break;
      }
    }
  }

  // Win check
  if(gameActive&&!tornado?.active&&!isDrawing){
    const cc={};for(const o of orbs)cc[o.color]=(cc[o.color]||0)+1;
    if(Object.values(cc).every(c=>c<=1)){
      const allStill=orbs.every(o=>Math.abs(o.vx)<0.5&&Math.abs(o.vy)<0.5);
      if(allStill){gameActive=false;setTimeout(()=>showComplete(),500)}
    }
  }

  for(let i=particles.length-1;i>=0;i--){particles[i].x+=particles[i].vx;particles[i].y+=particles[i].vy;particles[i].life-=0.02;if(particles[i].life<=0)particles.splice(i,1)}
  for(let i=flashes.length-1;i>=0;i--){flashes[i].radius+=4;flashes[i].alpha-=0.04;if(flashes[i].alpha<=0)flashes.splice(i,1)}
}

function draw(){
  const bg=ctx.createRadialGradient(W/2,H/2,0,W/2,H/2,Math.max(W,H)*0.7);
  bg.addColorStop(0,'#2a1010');bg.addColorStop(1,'#1a0a0a');
  ctx.fillStyle=bg;ctx.fillRect(0,0,W,H);

  // Swipe path drawing
  if(isDrawing&&swipePath.length>1){
    ctx.strokeStyle='rgba(255,87,34,0.5)';ctx.lineWidth=4;ctx.lineCap='round';ctx.lineJoin='round';
    ctx.beginPath();ctx.moveTo(swipePath[0].x,swipePath[0].y);
    for(let i=1;i<swipePath.length;i++)ctx.lineTo(swipePath[i].x,swipePath[i].y);
    ctx.stroke();
    // Glow
    ctx.strokeStyle='rgba(255,87,34,0.2)';ctx.lineWidth=12;
    ctx.beginPath();ctx.moveTo(swipePath[0].x,swipePath[0].y);
    for(let i=1;i<swipePath.length;i++)ctx.lineTo(swipePath[i].x,swipePath[i].y);
    ctx.stroke();
  }

  // Tornado path (faded)
  if(tornado&&tornado.active){
    ctx.strokeStyle='rgba(255,87,34,0.15)';ctx.lineWidth=3;ctx.setLineDash([6,6]);
    ctx.beginPath();ctx.moveTo(tornado.path[0].x,tornado.path[0].y);
    for(let i=1;i<tornado.path.length;i++)ctx.lineTo(tornado.path[i].x,tornado.path[i].y);
    ctx.stroke();ctx.setLineDash([]);
  }

  // Tornado
  if(tornado&&tornado.active){
    const t=tornado;
    // Vortex rings
    for(let r=0;r<5;r++){
      const ringR=10+r*12;
      const ringAlpha=0.3-r*0.05;
      ctx.strokeStyle=`rgba(255,87,34,${ringAlpha})`;ctx.lineWidth=2;
      ctx.beginPath();ctx.arc(t.x,t.y,ringR,t.rotation+r*0.5,t.rotation+r*0.5+Math.PI*1.5);ctx.stroke();
    }
    // Center
    const cg=ctx.createRadialGradient(t.x,t.y,0,t.x,t.y,25);
    cg.addColorStop(0,'rgba(255,87,34,0.5)');cg.addColorStop(1,'rgba(0,0,0,0)');
    ctx.fillStyle=cg;ctx.beginPath();ctx.arc(t.x,t.y,25,0,Math.PI*2);ctx.fill();
    // Radius indicator
    ctx.strokeStyle='rgba(255,87,34,0.1)';ctx.lineWidth=1;
    ctx.beginPath();ctx.arc(t.x,t.y,TORNADO_RADIUS,0,Math.PI*2);ctx.stroke();
  }

  // Flashes
  for(const f of flashes){
    const g=ctx.createRadialGradient(f.x,f.y,0,f.x,f.y,f.radius);
    g.addColorStop(0,f.color+`${f.alpha*0.5})`);g.addColorStop(1,'rgba(0,0,0,0)');
    ctx.fillStyle=g;ctx.beginPath();ctx.arc(f.x,f.y,f.radius,0,Math.PI*2);ctx.fill();
  }

  // Orbs
  for(const orb of orbs){
    const c=COLORS[orb.color],pulse=1+Math.sin(orb.pulse)*0.05,r=orb.radius*pulse;
    const glow=ctx.createRadialGradient(orb.x,orb.y,r*0.5,orb.x,orb.y,r*2.5);
    glow.addColorStop(0,c.glow+'0.4)');glow.addColorStop(1,'rgba(0,0,0,0)');
    ctx.fillStyle=glow;ctx.beginPath();ctx.arc(orb.x,orb.y,r*2.5,0,Math.PI*2);ctx.fill();
    const bodyG=ctx.createRadialGradient(orb.x-r*0.3,orb.y-r*0.3,r*0.1,orb.x,orb.y,r);
    bodyG.addColorStop(0,'#fff');bodyG.addColorStop(0.3,c.fill);bodyG.addColorStop(1,c.fill);
    ctx.fillStyle=bodyG;ctx.beginPath();ctx.arc(orb.x,orb.y,r,0,Math.PI*2);ctx.fill();
    ctx.fillStyle='rgba(255,255,255,0.4)';ctx.beginPath();ctx.arc(orb.x-r*0.25,orb.y-r*0.25,r*0.35,0,Math.PI*2);ctx.fill();
    if(orb.mergeCount>0){ctx.fillStyle='rgba(255,255,255,0.9)';ctx.font=`bold ${12+orb.mergeCount*2}px sans-serif`;ctx.textAlign='center';ctx.textBaseline='middle';ctx.fillText(`x${orb.mergeCount+1}`,orb.x,orb.y)}
  }

  // Particles
  for(const p of particles){
    if(p.isText){ctx.fillStyle=`rgba(255,255,255,${Math.min(1,p.life)})`;ctx.font='bold 18px sans-serif';ctx.textAlign='center';ctx.fillText(p.text,p.x,p.y)}
    else{ctx.fillStyle=`${p.color}${Math.min(1,p.life)})`;ctx.beginPath();ctx.arc(p.x,p.y,p.size*p.life,0,Math.PI*2);ctx.fill()}
  }
  if(comboCount>1){ctx.fillStyle=`rgba(255,171,145,${Math.min(1,comboCount*0.3)})`;ctx.font='bold 36px sans-serif';ctx.textAlign='center';ctx.fillText(`${comboCount}x COMBO!`,W/2,H/2-60)}
}

function gameLoop(){update();draw();requestAnimationFrame(gameLoop)}

function showComplete(){
  const cfg=levels[Math.min(level-1,levels.length-1)];
  let stars=1;if(swipeCount<=cfg.par)stars=3;else if(swipeCount<=cfg.par+1)stars=2;
  document.getElementById('lcStars').textContent='★'.repeat(stars)+'☆'.repeat(3-stars);
  document.getElementById('lcTitle').textContent=`레벨 ${level} 클리어!`;
  document.getElementById('lcInfo').textContent=`점수: ${score} | 스와이프: ${swipeCount}회 (기준: ${cfg.par}회)`;
  document.getElementById('levelComplete').style.display='flex';totalScore+=score;
  playSound(523,0.2,'sine',0.15);setTimeout(()=>playSound(659,0.2,'sine',0.15),150);setTimeout(()=>playSound(784,0.3,'sine',0.15),300);
}
function startGame(){document.getElementById('startScreen').style.display='none';document.getElementById('levelComplete').style.display='none';level=1;totalScore=0;initLevel(level);gameActive=true}
function nextLevel(){document.getElementById('levelComplete').style.display='none';level++;initLevel(level);gameActive=true}
function retryLevel(){document.getElementById('levelComplete').style.display='none';initLevel(level);gameActive=true}
gameLoop();
</script>
</body>
</html>
